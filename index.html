<!doctype html>
<html manifest="cache.manifest">
<head>
  <title>Daily Light</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="icon" sizes="192x192" href="icon.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon.png">
  <link rel="shortcut icon" href="favicon.png" type="image/x-icon" >
  <style>body{padding:20px 0 30px;font:14px/1.5 Arial,sans-serif;color:#333;background:#6495ed}.title{font-size:3em;position:relative;display:block;margin-bottom:5px;margin-left:50px;color:#3578f3;font-weight:800;height:10px;z-index:1}.card{max-width:600px;right:10px;left:10px;-moz-border-radius:10px;border-radius:10px;padding:1em;margin:2em 10px 4em;font-size:16px;background-color:#e8ebf9;-webkit-box-shadow:4px 4px 8px;-moz-box-shadow:0 1px 4px rgba(0,0,0,.3) box-shadow:4px 8px 8px rgba(0,0,0,.3)}.card .date{font-size:x-large;float:left}.card .morn_eve{font-size:large;padding-right:20px;float:right}.card .datepicker{width:100%}.card input.datepicker:focus{outline:none}.card .heading{font-size:1.1em;font-weight:700;text-align:center;margin-bottom:10px}.card .text{color:darkslategray;font-weight:400;text-indent:40px;white-space:pre-line}.card .references{font-style:italic;color:darkgrey;font-size:small;margin-top:10px;margin-bottom:10px}.card .missing{height:200px;padding-top:140px;font-size:large;text-align:center}#verses>p:first-child:first-letter{float:left; font-family:serif; font-size:3.3em; line-height:0.5;color:#ed9f64;padding:10px 8px 0 40px}#verses>p:first-child{text-indent:-8px}.card .text .lord{font-size:small}.card p.text{-webkit-animation:fadein 1s;-moz-animation:fadein 1s;animation:fadein 1s}@keyframes fadein{from{opacity:0}to{opacity:1}}@-moz-keyframes fadein{from{opacity:0}to{opacity:1}}@-webkit-keyframes fadein{from{opacity:0}to{opacity:1}}</style>
</head>
<body>
  <span class='title'>Daily Light</span>
  <div class='card'>
    <div class='date'></div>
    <div class='morn_eve' onclick='toggleMorning()'></div>
    <div style='clear:both;'></div>
    <input type='range' min='1' max='366' class='datepicker' autofocus oninput='loadDay(this.value);' />
    <div class='heading'></div>
    <div id='verses'></div>
    <div class='missing'>Missing content</div>
    <div class='references'></div>
  </div>
  <script type='text/javascript'>
    var morn_eve=new Date().getHours()<17?'morning':'evening';
    var thisYear = new Date().getFullYear();
    var missing = document.getElementsByClassName('missing')[0];
    var dayOfYear = function(date) {
       return Math.floor((new Date() - new Date(date.getFullYear(), 0, 0)) / 86400000);
    }
    var dateString = function(day) {
       var monthNames = ["January", "February", "March", "April", "May", "June","July", "August", "September", "October", "November", "December"];
       var date = new Date((new Date(thisYear, 0)).setDate(day));
       return monthNames[date.getMonth()]+' '+date.getDate();
    }
    var DOY = dayOfYear(new Date());
    if (localStorage) {
      if (localStorage.lastDOYRead && localStorage.lastOpened) {
          DOY = localStorage.lastDOYRead;
          //if already opened today, show same day, otherwise increment
          if (localStorage.lastOpened != dayOfYear(new Date())) {
              console.debug('not opened today, incrementing card')
              morn_eve='morning'
              console.log('Day of year::',DOY);
              DOY++;
              if (DOY>366) DOY=1;
          }
      }
      localStorage.lastDOYRead = DOY;
      localStorage.lastOpened = dayOfYear(new Date());
    }
    function toggleMorning() {
      morn_eve = morn_eve=='morning'?'evening':'morning';
      setMorning();
      loadDay(DOY);
    }
    function setMorning() {
      document.getElementsByClassName("morn_eve")[0].innerHTML=morn_eve;
    }
    function setDay(day) {
      document.getElementsByClassName("date")[0].innerHTML=dateString(day);
      document.getElementsByClassName("datepicker")[0].value=day;
      setMorning();
      DOY=day;
    }
    var data;
    function loadDay(day) {
      missing.style.display='none';
      document.getElementsByClassName("heading")[0].innerHTML='';
      document.getElementsByClassName("references")[0].innerHTML='';
      document.getElementById("verses").innerHTML='';
      if (!data) return;
      setDay(day);
      var item;
      item = data.days.day.filter(function(block) {return block.date==dateString(day);})
      if (item.length>0) {
        if (morn_eve=='morning') {
          item = item[0].morning
        } else {
          item = item[0].evening };
        document.getElementsByClassName("heading")[0].innerHTML=item.heading;
        document.getElementsByClassName("references")[0].innerHTML=item.references;
        document.getElementById("verses").innerHTML='';
        if (item.references.length>0) {
          document.getElementsByClassName("heading")[0].innerHTML=item.heading;
          document.getElementsByClassName("references")[0].innerHTML=item.references;
          document.getElementById("verses").innerHTML='';
          var firstWord = item.text.split(' ')[0];
          var text = firstWord.toUpperCase() + item.text.substring(firstWord.length);
          text.split('\n').forEach(function(verse) {
            var el = document.createElement('p');
            el.className='text'
            el.innerHTML=verse.replace(/LORD/g,'<span class="lord">LORD</span>');
            verses.appendChild(el);
          });
          localStorage.lastDOYRead = DOY;
          localStorage.lastOpened = dayOfYear(new Date());
        } else {
          missing.style.display='block';
        }
      } else {
        missing.style.display='block';
      }
    }

    if (DOY) setDay(DOY);
    var getJSON = function(url, callback) {
      var xhr = new XMLHttpRequest();
      xhr.open("get", url, true);
      xhr.responseType = "json";
      xhr.onload = function() {
        var status = xhr.status;
        if (status == 200) {
          callback(null, xhr.response);
        } else {
          callback(status);
        }
      };
      xhr.send();
    };
    getJSON('https://brentn.github.io/DailyLight/DailyLight.json', function(err, result) {
      if (err!=null) {
        console.error('Error loading data');
        data=undefined;
      }
      data=result;
      loadDay(DOY);
    })
  </script>
</body>
</html>
